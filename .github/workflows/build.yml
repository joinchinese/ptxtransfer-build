name: Build Static Ptxtransfer

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2019
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
    
    - name: Clean and Build Zlib
      shell: powershell
      run: |
        if (Test-Path "zlib") { Remove-Item -Recurse -Force "zlib" }
        git clone --depth 1 --branch v1.3 https://github.com/madler/zlib.git
        cd zlib
        
        $installPath = "$(Resolve-Path ..)/zlib-install" -replace '\\', '/'
        New-Item -ItemType Directory -Force -Path "../zlib-install" | Out-Null
        New-Item -ItemType Directory -Force -Path build | Out-Null
        
        cd build
        cmake .. -G "NMake Makefiles" -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="$installPath" -DBUILD_SHARED_LIBS=OFF
        nmake
        nmake install
        cd ../..
    
    - name: Clean and Build Ptex (No GLUT)
      shell: powershell
      run: |
        if (Test-Path "ptex") { Remove-Item -Recurse -Force "ptex" }
        git clone --depth 1 --branch v2.4.2 https://github.com/wdas/ptex.git
        cd ptex
        
        $zlibPath = "$(Resolve-Path ../zlib-install)" -replace '\\', '/'
        New-Item -ItemType Directory -Force -Path build | Out-Null
        
        cd build
        cmake .. -G "NMake Makefiles" `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_SHARED_LIBS=OFF `
          -DPTEX_BUILD_SHARED_LIBS=OFF `
          -DPTEX_BUILD_TESTS=OFF `
          -DPTEX_BUILD_EXAMPLES=OFF `
          -DPTEX_BUILD_DOCS=OFF `
          -DZLIB_ROOT="$zlibPath" `
          -DZLIB_LIBRARY="$zlibPath/lib/zlibstatic.lib"
        nmake
        cd ../..
    
    - name: Prepare Ptxutils Build Files
      shell: powershell
      run: |
        if (Test-Path "ptexutils") { Remove-Item -Recurse -Force "ptexutils" }
        git clone --depth 1 https://github.com/wdas/ptexutils.git
        cd ptxutils
        
        # 创建自定义 CMake 配置，避免修改原文件
        $ptexRoot = "$(Resolve-Path ../ptex)" -replace '\\', '/'
        $zlibRoot = "$(Resolve-Path ../zlib-install)" -replace '\\', '/'
        
        # 写入配置到文件，避免 YAML 转义问题
        $configContent = @"
        set(CMAKE_MSVC_RUNTIME_LIBRARY "MultiThreaded")
        set(PTEX_INCLUDE_DIR "$ptexRoot/build/src")
        set(PTEX_LIBRARY "$ptexRoot/build/src/Release/Ptex.lib")
        set(ZLIB_ROOT "$zlibRoot")
        set(ZLIB_LIBRARY "$zlibRoot/lib/zlibstatic.lib")
        include_directories(${PTEX_INCLUDE_DIR})
        link_directories($ptexRoot/build/src/Release $zlibRoot/lib)
        "@
        
        # 保存到文件
        $configContent | Out-File -FilePath "cmake/CustomPaths.cmake" -Encoding utf8
        
        # 修改 CMakeLists.txt 加载自定义配置
        $cmakelists = Get-Content CMakeLists.txt
        $cmakelists[0] = $cmakelists[0] + "`ninclude(cmake/CustomPaths.cmake)`n"
        
        # 替换 find_package 和 target_link_libraries
        $cmakelists = $cmakelists -replace 'find_package\s*\(\s*Ptex\s+REQUIRED\s*\)', ''
        $cmakelists = $cmakelists -replace 'Ptex::Ptex', '${PTEX_LIBRARY}'
        
        $cmakelists | Set-Content CMakeLists.txt
        cd ..
    
    - name: Build Ptxutils
      shell: powershell
      run: |
        cd ptxutils
        New-Item -ItemType Directory -Force -Path build | Out-Null
        cd build
        
        cmake .. -G "NMake Makefiles" -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF
        nmake
        cd ../..
    
    - name: Copy Executable
      shell: powershell
      run: |
        $exe = Get-ChildItem -Path "ptexutils" -Name "ptxtransfer.exe" -Recurse | Select-Object -First 1
        if (-not $exe) { throw "ptxtransfer.exe not found" }
        Copy-Item "ptexutils/$exe" "ptxtransfer.exe"
        Write-Host "Built successfully: $((Get-Item ptxtransfer.exe).FullName)"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ptxtransfer-windows-x64
        path: ptxtransfer.exe
    
    - name: Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ptxtransfer.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
