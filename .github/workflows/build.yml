name: Build Static Ptxtransfer

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2019
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
    
    - name: Build Zlib
      shell: powershell
      run: |
        git clone --depth 1 --branch v1.3 https://github.com/madler/zlib.git
        cd zlib
        
        $rootPath = ((Get-Location).Path | Split-Path) -replace '\\', '/'
        $installPath = "$rootPath/zlib-install"
        
        New-Item -ItemType Directory -Force -Path $installPath | Out-Null
        New-Item -ItemType Directory -Force -Path build | Out-Null
        
        cd build
        cmake .. -G "NMake Makefiles" `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_INSTALL_PREFIX="$installPath" `
          -DBUILD_SHARED_LIBS=OFF
        if ($LASTEXITCODE -ne 0) { throw "CMake failed" }
        nmake
        if ($LASTEXITCODE -ne 0) { throw "Build failed" }
        nmake install
        cd ../..
        
        Write-Host "Zlib installed at: $installPath"
        Get-ChildItem "$installPath" -Recurse | Select-Object -First 20
    
    - name: Build Ptex
      shell: powershell
      run: |
        git clone --depth 1 --branch v2.4.2 https://github.com/wdas/ptex.git
        cd ptex
        
        $rootPath = ((Get-Location).Path | Split-Path) -replace '\\', '/'
        $zlibPath = "$rootPath/zlib-install"
        $installPath = "$rootPath/ptex-install"
        
        if (!(Test-Path $zlibPath)) { throw "Zlib not found" }
        New-Item -ItemType Directory -Force -Path $installPath | Out-Null
        
        New-Item -ItemType Directory -Force -Path build | Out-Null
        cd build
        cmake .. -G "NMake Makefiles" `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_SHARED_LIBS=OFF `
          -DPTEX_BUILD_SHARED_LIBS=OFF `
          -DZLIB_ROOT="$zlibPath" `
          -DZLIB_LIBRARY="$zlibPath/lib/zlibstatic.lib" `
          -DCMAKE_INSTALL_PREFIX="$installPath"
        if ($LASTEXITCODE -ne 0) { throw "CMake failed" }
        nmake
        if ($LASTEXITCODE -ne 0) { throw "Build failed" }
        nmake install
        cd ../..
        
        Write-Host "Ptex installed at: $installPath"
        Write-Host "Checking for cmake config files:"
        Get-ChildItem "$installPath" -Recurse -Filter "*.cmake" -ErrorAction SilentlyContinue
    
    - name: Build Ptex
      shell: powershell
      run: |
        git clone --depth 1 --branch v2.4.2 https://github.com/wdas/ptex.git
        cd ptex
        
        $rootPath = ((Get-Location).Path | Split-Path) -replace '\\', '/'
        $zlibPath = "$rootPath/zlib-install"
        $installPath = "$rootPath/ptex-install"
        $buildPath = "$rootPath/ptex-build"
        
        if (!(Test-Path $zlibPath)) { throw "Zlib not found" }
        New-Item -ItemType Directory -Force -Path $installPath | Out-Null
        New-Item -ItemType Directory -Force -Path $buildPath | Out-Null
        
        cd $buildPath
        cmake .. -G "NMake Makefiles" `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_SHARED_LIBS=OFF `
          -DPTEX_BUILD_SHARED_LIBS=OFF `
          -DZLIB_ROOT="$zlibPath" `
          -DZLIB_LIBRARY="$zlibPath/lib/zlibstatic.lib" `
          -DCMAKE_INSTALL_PREFIX="$installPath"
        if ($LASTEXITCODE -ne 0) { throw "CMake failed" }
        nmake
        if ($LASTEXITCODE -ne 0) { throw "Build failed" }
        nmake install
        
        # 关键：同时保留 build 目录（包含 PtexTargets.cmake）
        Write-Host "Checking build directory for cmake files:"
        Get-ChildItem "." -Filter "*.cmake" -Recurse | Select-Object -First 10
        
        cd ../..

    - name: Build Ptxutils
      shell: powershell
      run: |
        git clone --depth 1 https://github.com/wdas/ptexutils.git
        cd ptxutils
        
        # 强制静态运行时
        $content = Get-Content CMakeLists.txt -Raw
        $content = $content -replace 'if\(PTEX_FOUND\)', "set(CMAKE_MSVC_RUNTIME_LIBRARY `"MultiThreaded`")`nif(PTEX_FOUND)"
        $content | Set-Content CMakeLists.txt -NoNewline
        
        $rootPath = ((Get-Location).Path | Split-Path) -replace '\\', '/'
        $ptexBuildPath = "$rootPath/ptex-build"  # 使用 build 目录而不是 install
        $zlibPath = "$rootPath/zlib-install"
        
        if (!(Test-Path $ptexBuildPath)) { throw "Ptex build dir not found" }
        
        # 查找 cmake 配置文件
        $ptexConfig = Get-ChildItem -Path "$ptexBuildPath" -Name "PtexConfig.cmake" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($ptexConfig) {
          $ptexCmakeDir = Split-Path (Join-Path "$ptexBuildPath" $ptexConfig) -Parent
          $env:Ptex_DIR = $ptexCmakeDir
          Write-Host "Found PtexConfig.cmake at: $ptexCmakeDir"
        } else {
          # 尝试直接使用 build 目录
          $env:Ptex_DIR = "$ptexBuildPath"
          Write-Host "Using Ptex build directory: $ptexBuildPath"
        }
        
        # 设置包含路径和库路径
        $env:CMAKE_PREFIX_PATH = "$ptexBuildPath;$zlibPath"
        
        New-Item -ItemType Directory -Force -Path build | Out-Null
        cd build
        
        cmake .. -G "NMake Makefiles" `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_SHARED_LIBS=OFF `
          -DCMAKE_PREFIX_PATH="$ptexBuildPath;$zlibPath" `
          -DPtex_DIR="$ptexBuildPath" `
          -DPTEX_INCLUDE_DIR="$ptexBuildPath/src" `
          -DPTEX_LIBRARY="$ptexBuildPath/src/Release/Ptex.lib" `
          -DZLIB_ROOT="$zlibPath" `
          -DZLIB_LIBRARY="$zlibPath/lib/zlibstatic.lib"
          
        if ($LASTEXITCODE -ne 0) { throw "CMake failed" }
        nmake
        if ($LASTEXITCODE -ne 0) { throw "Build failed" }
        cd ../..
    
    - name: Find and copy executable
      shell: powershell
      run: |
        $exe = Get-ChildItem -Path "ptexutils" -Name "ptxtransfer.exe" -Recurse | Select-Object -First 1
        if (!$exe) { 
          Write-Host "Searching all directories for ptxtransfer.exe..."
          $exe = Get-ChildItem -Path "." -Name "ptxtransfer.exe" -Recurse | Select-Object -First 1
        }
        if (!$exe) { throw "Executable not found" }
        $fullPath = Join-Path "." $exe
        Copy-Item $fullPath "ptxtransfer.exe"
        Write-Host "Copied from: $fullPath"
        Get-Item "ptxtransfer.exe"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ptxtransfer-windows-x64
        path: ptxtransfer.exe
    
    - name: Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ptxtransfer.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
