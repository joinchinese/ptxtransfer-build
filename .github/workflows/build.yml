name: Build Static Ptxtransfer

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2019
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
    
    - name: Build Zlib
      shell: powershell
      run: |
        git clone --depth 1 --branch v1.3 https://github.com/madler/zlib.git
        cd zlib
        
        $rootPath = ((Get-Location).Path | Split-Path) -replace '\\', '/'
        $installPath = "$rootPath/zlib-install"
        
        New-Item -ItemType Directory -Force -Path $installPath | Out-Null
        New-Item -ItemType Directory -Force -Path build | Out-Null
        
        cd build
        cmake .. -G "NMake Makefiles" `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_INSTALL_PREFIX="$installPath" `
          -DBUILD_SHARED_LIBS=OFF
        if ($LASTEXITCODE -ne 0) { throw "CMake failed" }
        nmake
        if ($LASTEXITCODE -ne 0) { throw "Build failed" }
        nmake install
        cd ../..
    
    - name: Build Ptex
      shell: powershell
      run: |
        git clone --depth 1 --branch v2.4.2 https://github.com/wdas/ptex.git
        cd ptex
        
        $rootPath = ((Get-Location).Path | Split-Path) -replace '\\', '/'
        $zlibPath = "$rootPath/zlib-install"
        $installPath = "$rootPath/ptex-install"
        
        if (!(Test-Path $zlibPath)) { throw "Zlib not found" }
        New-Item -ItemType Directory -Force -Path $installPath | Out-Null
        
        New-Item -ItemType Directory -Force -Path build | Out-Null
        cd build
        cmake .. -G "NMake Makefiles" `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_SHARED_LIBS=OFF `
          -DPTEX_BUILD_SHARED_LIBS=OFF `
          -DZLIB_ROOT="$zlibPath" `
          -DZLIB_LIBRARY="$zlibPath/lib/zlibstatic.lib" `
          -DCMAKE_INSTALL_PREFIX="$installPath"
        if ($LASTEXITCODE -ne 0) { throw "CMake failed" }
        nmake
        if ($LASTEXITCODE -ne 0) { throw "Build failed" }
        nmake install
        cd ../..
    
    - name: Build Ptxutils
      shell: powershell
      run: |
        git clone --depth 1 https://github.com/wdas/ptexutils.git
        cd ptexutils
        
        # 修改 CMakeLists.txt 强制静态运行时
        $content = Get-Content CMakeLists.txt -Raw
        $content = $content -replace 'if\(PTEX_FOUND\)', "set(CMAKE_MSVC_RUNTIME_LIBRARY `"MultiThreaded`")`nif(PTEX_FOUND)"
        $content | Set-Content CMakeLists.txt -NoNewline
        
        $rootPath = ((Get-Location).Path | Split-Path) -replace '\\', '/'
        $ptexPath = "$rootPath/ptex-install"
        $zlibPath = "$rootPath/zlib-install"
        
        if (!(Test-Path $ptexPath)) { throw "Ptex not found" }
        
        # 关键：设置 CMAKE_PREFIX_PATH 让 CMake 找到 PtexConfig.cmake
        $env:CMAKE_PREFIX_PATH = "$ptexPath/lib/cmake"
        
        New-Item -ItemType Directory -Force -Path build | Out-Null
        cd build
        cmake .. -G "NMake Makefiles" `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_SHARED_LIBS=OFF `
          -DCMAKE_PREFIX_PATH="$ptexPath/lib/cmake" `
          -DZLIB_ROOT="$zlibPath" `
          -DZLIB_LIBRARY="$zlibPath/lib/zlibstatic.lib"
        if ($LASTEXITCODE -ne 0) { throw "CMake failed" }
        nmake
        if ($LASTEXITCODE -ne 0) { throw "Build failed" }
        cd ../..
    
    - name: Find and copy executable
      shell: powershell
      run: |
        $exe = Get-ChildItem -Path "ptexutils" -Name "ptxtransfer.exe" -Recurse | Select-Object -First 1
        if (!$exe) { throw "Executable not found" }
        $fullPath = Join-Path "ptexutils" $exe
        Copy-Item $fullPath "ptxtransfer.exe"
        Write-Host "Found and copied: $exe"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ptxtransfer-windows-x64
        path: ptxtransfer.exe
    
    - name: Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ptxtransfer.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
