name: Build Static Ptxtransfer

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2019
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
    
    - name: Build Zlib
      shell: pwsh
      run: |
        if (Test-Path "zlib") { Remove-Item -Recurse -Force "zlib" }
        git clone --depth 1 --branch v1.3 https://github.com/madler/zlib.git
        cd zlib
        
        New-Item -ItemType Directory -Force -Path "../zlib-install" | Out-Null
        $install = (Resolve-Path "../zlib-install").Path
        New-Item -ItemType Directory -Force -Path build | Out-Null
        cd build
        
        cmake .. -G "NMake Makefiles" -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="$install" -DBUILD_SHARED_LIBS=OFF
        if ($LASTEXITCODE -ne 0) { exit 1 }
        nmake && nmake install
        cd ../..
    
    - name: Build Ptex
      shell: pwsh
      run: |
        if (Test-Path "ptex") { Remove-Item -Recurse -Force "ptex" }
        git clone --depth 1 --branch v2.4.2 https://github.com/wdas/ptex.git
        cd ptex
        
        $zlib = (Resolve-Path "../zlib-install").Path
        New-Item -ItemType Directory -Force -Path build | Out-Null
        cd build
        
        cmake .. -G "NMake Makefiles" `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_SHARED_LIBS=OFF `
          -DPTEX_BUILD_SHARED_LIBS=OFF `
          -DPTEX_BUILD_TESTS=OFF `
          -DPTEX_BUILD_EXAMPLES=OFF `
          -DPTEX_BUILD_DOCS=OFF `
          -DZLIB_ROOT="$zlib" `
          -DZLIB_LIBRARY="$zlib/lib/zlibstatic.lib"
        if ($LASTEXITCODE -ne 0) { exit 1 }
        nmake
        cd ../..
    
    - name: Download Ptxutils
      shell: pwsh
      run: |
        if (Test-Path "ptexutils") { Remove-Item -Recurse -Force "ptexutils" }
        git clone --depth 1 https://github.com/wdas/ptexutils.git
    
    - name: Patch and Build Ptxutils
      shell: cmd
      run: |
        cd ptexutils
        
        rem 创建简单的 CMake 配置文件
        mkdir cmake 2>nul
        echo set(CMAKE_MSVC_RUNTIME_LIBRARY "MultiThreaded") > cmake/CustomPaths.cmake
        echo set(PTEX_INCLUDE_DIR "%CD%/../ptex/build/src") >> cmake/CustomPaths.cmake
        echo set(PTEX_LIBRARY "%CD%/../ptex/build/src/Release/Ptex.lib") >> cmake/CustomPaths.cmake
        echo set(ZLIB_LIBRARY "%CD%/../zlib-install/lib/zlibstatic.lib") >> cmake/CustomPaths.cmake
        
        rem 修改 CMakeLists.txt
        powershell -Command "(Get-Content CMakeLists.txt) -replace 'find_package\(Ptex REQUIRED\)', 'include(cmake/CustomPaths.cmake)' | Set-Content CMakeLists.txt"
        powershell -Command "(Get-Content CMakeLists.txt) -replace 'Ptex::Ptex', '${PTEX_LIBRARY}' | Set-Content CMakeLists.txt"
        
        rem 构建
        mkdir build
        cd build
        cmake .. -G "NMake Makefiles" -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF
        nmake
        cd ../..
    
    - name: Copy Executable
      shell: pwsh
      run: |
        $exe = Get-ChildItem -Path "ptexutils" -Name "ptxtransfer.exe" -Recurse | Select-Object -First 1
        if (-not $exe) { throw "Executable not found" }
        Copy-Item (Join-Path "ptexutils" $exe) "ptxtransfer.exe"
        Write-Host "Success"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ptxtransfer-windows-x64
        path: ptxtransfer.exe
    
    - name: Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ptxtransfer.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
